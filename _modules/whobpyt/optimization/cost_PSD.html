

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>whobpyt.optimization.cost_PSD &mdash; WhoBPyT 0.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_override.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/gallery-dataframe.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
        <script src="../../../_static/sphinx_tabs/tabs.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script src="../../../_static/debug.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> WhoBPyT
          

          
          </a>

          
            
            
              <div class="version">
                0.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">About WhoBPyT</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about_whobpyt/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about_whobpyt/architecture.html">Code Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/architecture.html#simplified-usage-pseudo-code">Simplified Usage Pseudo Code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/architecture.html#whole-brain-models">Whole Brain Models:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/architecture.html#objective-function-components">Objective Function Components:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/architecture.html#parameter-fitting-paradigms">Parameter Fitting Paradigms:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/architecture.html#package-expansions">Package Expansions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../about_whobpyt/background.html">Background Information</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/background.html#neuroimaging-data">Neuroimaging Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../about_whobpyt/background.html#system-model-and-biophysical-parameters">System, Model, and Biophysical Parameters</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../about_whobpyt/background.html#rwwexcinb">RWWExcInb</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../about_whobpyt/background.html#jansen-rit">Jansen-Rit</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/running_in_colab.html">Running whobpyt in google colab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/running_in_codespaces.html">Running whobpyt in GitHub Codespaces</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../API/models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/optimization.html">Optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/run.html">Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/visualization.html">Visualization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API/datatypes.html">Data Types</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html">Fitting S_E Mean to 0.164 using default RWW Parameters</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#importage">Importage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#defining-model-parameters">Defining Model Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#using-the-synthetic-cube-data-for-demo-purposes">Using the Synthetic Cube Data For Demo Purposes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#defining-the-cnmm-model">Defining the CNMM Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#defining-the-objective-function">Defining the Objective Function</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#training-the-model">Training The Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#model-simulation">Model Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg002r__multimodal_simulation.html#cnmm-validation-model">CNMM Validation Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/eg003r__fitting_rww_example.html">Fitting Wong_Wang model (HCP data)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg003r__fitting_rww_example.html#importage">Importage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg003r__fitting_rww_example.html#model-training">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg003r__fitting_rww_example.html#model-evaluation-with-20-window-for-warmup">Model Evaluation (with 20 window for warmup)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/eg004r__fitting_JR_example.html">Fitting JR model (Tepit data)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg004r__fitting_JR_example.html#importage">Importage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg004r__fitting_JR_example.html#model-training">Model Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg004r__fitting_JR_example.html#model-evaluation-with-20-window-for-warmup">Model Evaluation (with 20 window for warmup)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html">Evaluating CPU vs. GPU Performance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html#importage">Importage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html#defining-the-data-and-parameters">Defining the Data and Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html#training-a-cnmm-model-fixed-psd-with-batched-paradigm">Training a CNMM Model - Fixed PSD with Batched Paradigm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html#training-a-cnmm-model-multimodal-objective-with-fng-fpg-paradigm">Training a CNMM Model - Multimodal Objective with FNG-FPG Paradigm</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../auto_examples/eg005r__gpu_support.html#cnmm-verification-model">CNMM Verification Model</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">WhoBPyT</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>whobpyt.optimization.cost_PSD</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for whobpyt.optimization.cost_PSD</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>
<span class="kn">from</span> <span class="nn">whobpyt.datatypes.AbstractLoss</span> <span class="kn">import</span> <span class="n">AbstractLoss</span>

<div class="viewcode-block" id="CostsPSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD">[docs]</a><span class="k">class</span> <span class="nc">CostsPSD</span><span class="p">(</span><span class="n">AbstractLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    WARNING: This function is no longer supported.</span>
<span class="sd">    TODO: Needs to be updated. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># TODO: Deal with num_region vs. num_channels vs. num_parcels conflict with variable naming</span>
<div class="viewcode-block" id="CostsPSD.__init__"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">simKey</span><span class="p">,</span> <span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">targetValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">empiricalData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CostsPSD</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simKey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span> <span class="o">=</span> <span class="n">num_regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simKey</span> <span class="o">=</span> <span class="n">simKey</span>  <span class="c1"># This is the index in the data simulation to extract variable time series from</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sampleFreqHz</span> <span class="o">=</span> <span class="n">sampleFreqHz</span>
        
        <span class="k">if</span> <span class="n">targetValue</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targetValue</span> <span class="o">=</span> <span class="n">targetValue</span>
        
        <span class="k">if</span> <span class="n">empiricalData</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># In the future, if given empiricalData then will calculate the target value in this initialization function. </span>
            <span class="c1"># That will possibly involve a time series of targets, for which then the loss would need a parameter to identify</span>
            <span class="c1"># which one to fit to.</span>
            <span class="k">pass</span>
        <span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> will be deprecated.&#39;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="CostsPSD.calcPSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD.calcPSD">[docs]</a>    <span class="k">def</span> <span class="nf">calcPSD</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">minFreq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axMethod</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
        <span class="c1"># signal assumed to be in the form of [time_steps, regions or channels]</span>
        <span class="c1"># Returns the Power Spectrial Density with associated Hz values</span>
    
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        
        <span class="c1"># These defines the range of the PSD to return</span>
        <span class="k">if</span> <span class="n">minFreq</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minFreq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">maxFreq</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span>
        
        <span class="c1"># Not sure which axis method is correct</span>
        <span class="k">if</span> <span class="n">axMethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fftAxis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axMethod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fftAxis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">sampleFreqHz</span><span class="o">/</span><span class="n">N</span>
        
        <span class="c1"># Take the FFT of the Signal</span>
        <span class="n">signalFFT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Take the square value (it is complex) so following is equivalent:</span>
        <span class="c1"># Square of absolute, or</span>
        <span class="c1"># Sum of real squared and imag squared</span>
        <span class="n">spectralDensity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signalFFT</span><span class="p">[:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="c1">#Filter to the desired range</span>
        <span class="n">minPoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">minFreq</span><span class="o">/</span><span class="p">(</span><span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spectralDensity</span><span class="p">))</span>
        <span class="n">maxPoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">maxFreq</span><span class="o">/</span><span class="p">(</span><span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spectralDensity</span><span class="p">))</span>
        <span class="n">sdAxis</span> <span class="o">=</span> <span class="n">fftAxis</span><span class="p">[</span><span class="n">minPoint</span><span class="p">:</span><span class="n">maxPoint</span><span class="p">]</span>
        <span class="n">sdValues</span> <span class="o">=</span> <span class="n">spectralDensity</span><span class="p">[</span><span class="n">minPoint</span><span class="p">:</span><span class="n">maxPoint</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">sdAxis</span><span class="p">,</span> <span class="n">sdValues</span></div>
    
<div class="viewcode-block" id="CostsPSD.downSmoothPSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD.downSmoothPSD">[docs]</a>    <span class="k">def</span> <span class="nf">downSmoothPSD</span><span class="p">(</span><span class="n">sdAxis</span><span class="p">,</span> <span class="n">sdValues</span><span class="p">,</span> <span class="n">numPoints</span> <span class="o">=</span> <span class="mi">512</span><span class="p">):</span>
        <span class="c1">#WARNING: This function will not necessarily achieve exactly numPoints number of points</span>
        
        <span class="n">kernel_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdValues</span><span class="p">)</span><span class="o">//</span><span class="p">(</span><span class="n">numPoints</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="n">kernel_size</span><span class="o">//</span><span class="mi">2</span>
        
        <span class="n">sdAxis_dS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">avg_pool1d</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">sdAxis</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">kernel_size</span><span class="p">,</span><span class="n">stride</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sdValues_dS</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">avg_pool1d</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sdValues</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">kernel_size</span><span class="p">,</span><span class="n">stride</span><span class="p">,</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span> <span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS</span></div>
    
<div class="viewcode-block" id="CostsPSD.scalePSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD.scalePSD">[docs]</a>    <span class="k">def</span> <span class="nf">scalePSD</span><span class="p">(</span><span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS</span><span class="p">):</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">sdValues_dS</span><span class="p">,</span> <span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Alternative Method: </span>
        <span class="c1"># spacing = (sdAxis_dS[-1] - sdAxis_dS[0])/len(sdAxis_dS)</span>
        <span class="c1"># scale = torch.trapezoid(sdValues_dS, dx = spacing, dim = 0)</span>
        
        <span class="n">sdValues_dS_scaled</span> <span class="o">=</span> <span class="n">sdValues_dS</span> <span class="o">/</span> <span class="n">scale</span>
        
        <span class="k">return</span> <span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS_scaled</span></div>

    
<div class="viewcode-block" id="CostsPSD.loss"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsPSD.loss">[docs]</a>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simData</span><span class="p">,</span> <span class="n">empData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1"># simData assumed to be dict with values in the form [time_steps, regions or channels, one or more variables]</span>
        <span class="c1"># Returns the MSE of the difference between the simulated and target power spectrum</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">simData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">simKey</span><span class="p">]</span>
        
        <span class="n">sdAxis</span><span class="p">,</span> <span class="n">sdValues</span> <span class="o">=</span> <span class="n">powerSpectrumLoss</span><span class="o">.</span><span class="n">calcPSD</span><span class="p">(</span><span class="n">sim</span><span class="p">[:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simKey</span><span class="p">],</span> <span class="n">sampleFreqHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">minFreq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="mi">40</span><span class="p">)</span>
        <span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS</span> <span class="o">=</span> <span class="n">powerSpectrumLoss</span><span class="o">.</span><span class="n">downSmoothPSD</span><span class="p">(</span><span class="n">sdAxis</span><span class="p">,</span> <span class="n">sdValues</span><span class="p">,</span> <span class="n">numPoints</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span>
        <span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS_scaled</span> <span class="o">=</span> <span class="n">powerSpectrumLoss</span><span class="o">.</span><span class="n">scalePSD</span><span class="p">(</span><span class="n">sdAxis_dS</span><span class="p">,</span> <span class="n">sdValues_dS</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">sdValues_dS_scaled</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetValue</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CostsFixedPSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsFixedPSD">[docs]</a><span class="k">class</span> <span class="nc">CostsFixedPSD</span><span class="p">(</span><span class="n">AbstractLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updated Code that fits to a fixed PSD</span>
<span class="sd">    </span>
<span class="sd">    The simulated PSD is generated as the square of the Fast Fourier Transform (FFT). A particular range to fit on is selected. The mean is not removed, so it is recommended to set the range such as to disclude the first point of the PSD. Removing an initial transient period before calculating the PSD is also recommended. </span>
<span class="sd">    </span>
<span class="sd">    Designed for Fitting_Batch, where the model output has an extra dimension for batch. TODO: Generalize further to work in case without this dimension as well. </span>
<span class="sd">     </span>
<span class="sd">    NOTE: If using batching, the batches will be averaged before calculating the error (as opposed to having an error for each time series in the batch). </span>
<span class="sd">    </span>
<span class="sd">    Has GPU support.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    simKey: String</span>
<span class="sd">        Name of the state variable or modality to be used as input to the cost function. </span>
<span class="sd">    num_regions: Int</span>
<span class="sd">        The number of nodes in the model. </span>
<span class="sd">    batch_size: Int</span>
<span class="sd">        The number of elements in the batch. </span>
<span class="sd">    rmTransient: Int</span>
<span class="sd">        The number of initial time steps of simulation to remove as the transient. Default: 0</span>
<span class="sd">    device: torch.device</span>
<span class="sd">        Whether to run the objective function on CPU or GPU.</span>
<span class="sd">    sampleFreqHz: Int</span>
<span class="sd">        The sampling frequency of the data.        </span>
<span class="sd">    targetValue: torch.tensor</span>
<span class="sd">        The target PSD. This is assumed to be created with the same frequency range and density as that of the PSD generated from the simulated data. </span>
<span class="sd">    empiricalData: torch.tensor</span>
<span class="sd">        NOT IMPLEMENTED: This is a placeholder for the case of getting an empirical timeseries as input, which would be applicable if doing a windowed fitting paradigm</span>
<span class="sd">       </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="CostsFixedPSD.__init__"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsFixedPSD.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_regions</span><span class="p">,</span> <span class="n">simKey</span><span class="p">,</span> <span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span><span class="p">,</span> <span class="n">targetValue</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">empiricalData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rmTransient</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        num_regions; Int</span>
<span class="sd">            The number of nodes in the model.             </span>
<span class="sd">        simKey: String</span>
<span class="sd">            Name of the state variable or modality to be used as input to the cost function.         </span>
<span class="sd">        sampleFreqHz: Int</span>
<span class="sd">            The sampling frequency of the data.</span>
<span class="sd">        minFreq: Int</span>
<span class="sd">            The minimum frequnecy of the PSD to return.</span>
<span class="sd">        maxFreq: Int</span>
<span class="sd">            The maximum frequency of the PSD to return.            </span>
<span class="sd">        targetValue: torch.tensor</span>
<span class="sd">            The sampling frequency of the data.</span>
<span class="sd">        empiricalData: torch.tensor</span>
<span class="sd">            NOT IMPLEMENTED: This is a placeholder for the case of getting an empirical timeseries as input, which would be applicable if doing a windowed fitting paradigm            </span>
<span class="sd">        batch_size: Int</span>
<span class="sd">            The number of elements in the batch. </span>
<span class="sd">        rmTransient: Int</span>
<span class="sd">            The number of initial time steps of simulation to remove as the transient. Default: 0        </span>
<span class="sd">        device: torch.device</span>
<span class="sd">            Whether to run the objective function on CPU or GPU.        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CostsFixedPSD</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">simKey</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_regions</span> <span class="o">=</span> <span class="n">num_regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simKey</span> <span class="o">=</span> <span class="n">simKey</span>  <span class="c1"># This is the index in the data simulation to extract variable time series from</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rmTransient</span> <span class="o">=</span> <span class="n">rmTransient</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sampleFreqHz</span> <span class="o">=</span> <span class="n">sampleFreqHz</span> <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minFreq</span> <span class="o">=</span> <span class="n">minFreq</span> <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxFreq</span> <span class="o">=</span> <span class="n">maxFreq</span> <span class="c1">#</span>
        
        <span class="k">if</span> <span class="n">targetValue</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targetValue</span> <span class="o">=</span> <span class="n">targetValue</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">targetValue</span> <span class="o">=</span> <span class="n">targetValue</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">num_regions</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="c1">#TODO: Currently taking mean before MSE from all batches, need to document this</span>
        
        <span class="k">if</span> <span class="n">empiricalData</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># In the future, if given empiricalData then will calculate the target value in this initialization function. </span>
            <span class="c1"># That will possibly involve a time series of targets, for which then the loss would need a parameter to identify</span>
            <span class="c1"># which one to fit to.</span>
            <span class="k">pass</span></div>
    
<div class="viewcode-block" id="CostsFixedPSD.calcPSD"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsFixedPSD.calcPSD">[docs]</a>    <span class="k">def</span> <span class="nf">calcPSD</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">minFreq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axMethod</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method calculates the Power Spectral Density (PSD) as the square of the Fast Fourier Transform (FFT). </span>
<span class="sd">        </span>
<span class="sd">        Tested when working with the default simulation frequency of 10,000Hz. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        signal: dict of torch.tensor</span>
<span class="sd">            The timeseries outputted by a model. Dimensions: [nodes, time, batch]</span>
<span class="sd">        sampleFreqHz: Int</span>
<span class="sd">            The sampling frequency of the data.</span>
<span class="sd">        minFreq: Int</span>
<span class="sd">            The minimum frequnecy of the PSD to return.</span>
<span class="sd">        maxFreq: Int</span>
<span class="sd">            The maximum frequency of the PSD to return.</span>
<span class="sd">        axMethod: Int</span>
<span class="sd">            Either 1 or 2 depending on the approach to calculate the PSD axis.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sdAxis: torch.tensor</span>
<span class="sd">            The axis values of the PSD</span>
<span class="sd">        sdValues: torch.tensor</span>
<span class="sd">            The PSD values [____, ____]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1"># signal assumed to be in the form of [time_steps, regions or channels] &lt;- This is being changed</span>
        <span class="c1"># Returns the Power Spectrial Density with associated Hz values</span>
    
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rmTransient</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">rmTransient</span><span class="p">:,:]</span>
    
        <span class="n">N</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># These defines the range of the PSD to return</span>
        <span class="k">if</span> <span class="n">minFreq</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minFreq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">maxFreq</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span>
        
        <span class="c1"># Not sure which axis method is correct</span>
        <span class="k">if</span> <span class="n">axMethod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fftAxis</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axMethod</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">fftAxis</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">sampleFreqHz</span><span class="o">/</span><span class="n">N</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># Take the FFT of the Signal</span>
        <span class="n">signalFFT</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Take the square value (it is complex) so following is equivalent:</span>
        <span class="c1"># Square of absolute, or</span>
        <span class="c1"># Sum of real squared and imag squared</span>
        <span class="n">spectralDensity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">signalFFT</span><span class="p">[:,:</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">,:])</span><span class="o">**</span><span class="mi">2</span>
        
        <span class="c1">#Filter to the desired range</span>
        <span class="n">minPoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">minFreq</span><span class="o">/</span><span class="p">(</span><span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">maxPoint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">maxFreq</span><span class="o">/</span><span class="p">(</span><span class="n">sampleFreqHz</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">sdAxis</span> <span class="o">=</span> <span class="n">fftAxis</span><span class="p">[</span><span class="n">minPoint</span><span class="p">:</span><span class="n">maxPoint</span><span class="p">]</span>
        <span class="n">sdValues</span> <span class="o">=</span> <span class="n">spectralDensity</span><span class="p">[:,</span><span class="n">minPoint</span><span class="p">:</span><span class="n">maxPoint</span><span class="p">,:]</span>
        
        <span class="k">return</span> <span class="n">sdAxis</span><span class="p">,</span> <span class="n">sdValues</span></div>
               
<div class="viewcode-block" id="CostsFixedPSD.loss"><a class="viewcode-back" href="../../../API/optimization.html#whobpyt.optimization.CostsFixedPSD.loss">[docs]</a>    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simData</span><span class="p">,</span> <span class="n">empData</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        NOTE: If using batching, the batches will be averaged before calculating the error (as opposed to having an error for each simulated time series in the batch).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        simData: torch.tensor</span>
<span class="sd">            Simulated Data in the form [regions, time_steps, block/batch]</span>
<span class="sd">        empData: torch.tensor</span>
<span class="sd">            NOT IMPLEMENTED: This is a placeholder for the case of getting an empirical timeseries as input, which would be applicable if doing a windowed fitting paradigm</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        psdMSE:</span>
<span class="sd">            The MSE of the difference between the simulated and target power spectrum within the specified range</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sim</span> <span class="o">=</span> <span class="n">simData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">simKey</span><span class="p">]</span>
        
        <span class="n">psdAxis</span><span class="p">,</span> <span class="n">psdValues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcPSD</span><span class="p">(</span><span class="n">sim</span><span class="p">,</span> <span class="n">sampleFreqHz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampleFreqHz</span><span class="p">,</span> <span class="n">minFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minFreq</span><span class="p">,</span> <span class="n">maxFreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxFreq</span><span class="p">)</span> <span class="c1"># TODO: Sampling frequency of simulated data and target time series is currently assumed to be the same.</span>
        
        <span class="n">meanValue</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">psdValues</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
        <span class="n">psdMSE</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">meanValue</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targetValue</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">psdMSE</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright KCNI Griffiths Lab &amp; Contributors

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>